
#include <drivers/lan9252.h>

LAN9252::LAN9252(
		Port::SPIComm 	&spi,
		Port::CS 		&cs,
		Port::EXIT 		&spiIrq,
		Port::EXIT 		&sync0,
		Port::EXIT 		&sync1,
		Port::TIM		&tim
		)
: spi_(spi),
  cs_(cs),
  spiIrq_(spiIrq),
  sync0_(sync0),
  sync1_(sync1),
  tim_(tim)
{


}

LAN9252::~LAN9252()
{

}

void LAN9252::Write(uint16_t address, uint32_t val)
{
	spiTxData_[0] = ESC_CMD_SERIAL_WRITE;
	spiTxData_[1] = ((address >> 8) & 0xFF);
	spiTxData_[2] = (address & 0xFF);
	spiTxData_[3] = (val & 0xFF);
	spiTxData_[4] = ((val >> 8) & 0xFF);
	spiTxData_[5] = ((val >> 16) & 0xFF);
	spiTxData_[6] = ((val >> 24) & 0xFF);


	cs_.Select();
	spi_.Transmit(spiTxData_, 7, 100);
    cs_.Release();
}

uint32_t LAN9252::Read(uint32_t address)
{
	spiTxData_[0] = ESC_CMD_FAST_READ;
	spiTxData_[1] = ((address >> 8) & 0xFF);
	spiTxData_[2] = (address & 0xFF);
	spiTxData_[3] = ESC_CMD_FAST_READ_DUMMY;

	cs_.Select();
	spi_.TransmitReceive(spiTxData_, spiRxData_, 4, 100);
	cs_.Release();

	regVal_ = (spiRxData_[3] << 24) |  (spiRxData_[2] << 16) | (spiRxData_[1] << 8) | spiRxData_[0];

	return regVal_;
}

void LAN9252::EscReadCsr(uint16_t address, void *buf, uint16_t len)
{
	uint32_t value;

	value = (ESC_CSR_CMD_READ | ESC_CSR_CMD_SIZE(len) | address);
	Write(ESC_CSR_CMD_REG, value);

	do
	{
	  value = Read(ESC_CSR_CMD_REG);
	} while(value & ESC_CSR_CMD_BUSY);

	value = Read(ESC_CSR_DATA_REG);
	memcpy(buf, (uint8_t *)&value, len);
}

void LAN9252::EscWriteCsr(uint16_t address, void *buf, uint16_t len)
{

}
